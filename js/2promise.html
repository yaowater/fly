<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>


<script>

// 使用Promise封装ajax
function promiseAjax(options){
    return new Promise(function(resolve,reject){
        // 1.创建XMLHttpRequest对象（数据交互对象）
        var xhr = new XMLHttpRequest();//w3c标准
        // var xhr = new ActiveXObject('Microsoft.XMLHTTP');//IE 5 6

        var data = '';
        if (typeof options.data === 'string'){
            data = options.data;
        }
        if (typeof options.data === 'object' && options.data !== null && options.data.constructor === Object){
            // 把{abc:123,ddd:777} 转成 'abc=123&ddd=777'
            for (var key in options.data){
                data += key+'='+options.data[key]+'&';
            }
            // data = 'abc=123&ddd=777&';
            data = data.substring(0,data.length-1);
            // console.log(data);
        }
        // return;

        // 判断请求方式
        if (options.type.toLowerCase() === 'get'){
            xhr.open(options.type,options.url+'?'+data+'&_='+Date.now(),true);
            xhr.send(null);// get请求
        } else if (options.type.toLowerCase() === 'post'){
            xhr.open(options.type,options.url,true);
            // 作用是模拟表单post来传递参数
            xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
            xhr.send(data);// post请求发送数据 
        } else {
            alert('目前只支持 get和post 请求！')
        }

        // 4.请求-响应 状态
        xhr.onreadystatechange = function (){
            // console.log(xhr.readyState);
            if (xhr.readyState == 4){//请求完成 （请求状态）
                if(xhr.status >= 200 && xhr.status < 300){// 得到响应数据 （响应状态）
                    resolve(xhr.responseText);
                } else{
                    reject(xhr.status);
                }
            }
        }
    });
}

// promiseAjax({
//     url: './promise.php',
//     type: 'get',
//     data: 'id=123'
// })
// .then(function(data){
//     var json = JSON.parse(data);
//     console.log(json.name);
//     return promiseAjax({
//         url: './promise.php',
//         type: 'get',
//         data: 'id='+json.code
//     })
// })
// .then(function(data){
//     var json = JSON.parse(data);
//     console.log(json.phone);
//     return promiseAjax({
//         url: './promise.php',
//         type: 'get',
//         data: 'id='+json.code
//     })
// })
// .then(function(data){
//     var json = JSON.parse(data);
//     console.log(json.address);
// })
// .catch(function(err){
//     console.log(err);
// })
// .finally(function(){
//     console.log('所有程序执行完成');
// })


// 现在有三个数据接口，如何保证三个数据接口都得到数据之后再执行后面的程序
var p1 = promiseAjax({
    url: './promise.php',
    type: 'get',
    data: 'id=123'
});
var p2 = promiseAjax({
    url: './promise.php',
    type: 'get',
    data: 'id=a123'
});
var p3 = promiseAjax({
    url: './promise.php',
    type: 'get',
    data: 'id=a666'
});
var p4 = Promise.all([p1,p2,p3]);
// 数组中的所有promise对象都为成功状态时，p4才是成功的状态，数组中任何一个promise对象为失败时，p4就是失败状态
p4.then(function(data){
    console.log(data);
    console.log('程序4');
},function(err){
    console.log(err)
})




</script>
</body>
</html>