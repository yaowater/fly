<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>


<script>
// 使用Promise封装ajax
function promiseAjax(options){
    return new Promise(function(resolve,reject){
        // 1.创建XMLHttpRequest对象（数据交互对象）
        var xhr = new XMLHttpRequest();//w3c标准
        // var xhr = new ActiveXObject('Microsoft.XMLHTTP');//IE 5 6

        var data = '';
        if (typeof options.data === 'string'){
            data = options.data;
        }
        if (typeof options.data === 'object' && options.data !== null && options.data.constructor === Object){
            // 把{abc:123,ddd:777} 转成 'abc=123&ddd=777'
            for (var key in options.data){
                data += key+'='+options.data[key]+'&';
            }
            // data = 'abc=123&ddd=777&';
            data = data.substring(0,data.length-1);
            // console.log(data);
        }
        // return;

        // 判断请求方式
        if (options.type.toLowerCase() === 'get'){
            xhr.open(options.type,options.url+'?'+data+'&_='+Date.now(),true);
            xhr.send(null);// get请求
        } else if (options.type.toLowerCase() === 'post'){
            xhr.open(options.type,options.url,true);
            // 作用是模拟表单post来传递参数
            xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
            xhr.send(data);// post请求发送数据 
        } else {
            alert('目前只支持 get和post 请求！')
        }

        // 4.请求-响应 状态
        xhr.onreadystatechange = function (){
            // console.log(xhr.readyState);
            if (xhr.readyState == 4){//请求完成 （请求状态）
                if(xhr.status >= 200 && xhr.status < 300){// 得到响应数据 （响应状态）
                    resolve(xhr.responseText);
                } else{
                    reject(xhr.status);
                }
            }
        }
    });
}



// async
async function test(){// 异步函数
    // console.lag(888);// reject(888);
    return 123;// resolve(123)
    // return undefined;//函数默认返回值
}
// console.log( test() );// Promise {<resolved>: 123}
// test()//执行后返回 promise对象
// .then((msg)=>{
//     console.log(msg);//123
// },(err)=>{
//     console.log(err);
// })


// 异步函数的多种形式
async function fn1(){}
var fn2 = async function (){};
var obj = {
    name:'xm',
    async say(){

    }
}
class Cat {
    constructor(){

    }
    async skill(){

    }
}
let fn3 = async ()=>{}
(async function (){

})();

// await 等待后面的结果，只能在异步函数中使用
// function fn4(){// 普通函数内不能使用await
//     await 123;//await is only valid in async function
// }
// fn4();

// (async function (){
//     var res1 = await 123;// awaith后面不是promise对象时，直接返回await后面的值
//     console.log(res1);//123
//     // awaith后面是promise对象时，await返回的值为promise的结果
//     try{
//         var res2 = await new Promise((resolve,reject)=>{
//             // resolve('成功');
//             reject('失败');
//         });
//         console.log(res2);
//     } catch(e){}
//     var res3 = await new Promise((resolve,reject)=>{
//         resolve('成功');
//         // reject('失败');
//     });
//     console.log(res3);
// })().catch(function (err){
//     console.log(err);
// })

// console.log('程序1');
// try{
//     console.lag('程序2');
// } catch(e){}
// console.log('程序3');


// 实战应用
// (async function (){
//     console.log('任务1完成');
//     await new Promise((resolve,reject)=>{
//         setTimeout(()=>{
//             console.log('任务2完成');
//             resolve();
//         },1000);
//     });
//     console.log('任务3完成');
//     await new Promise((resolve,reject)=>{
//         setTimeout(()=>{
//             console.log('任务4完成');
//             resolve();
//         },2000);
//     });
// })();

(async ()=>{
    var data1 = await promiseAjax({
        url: './promise.php',
        type: 'get',
        data: 'id=123'
    });
    var json1 = JSON.parse(data1);
    var data2 = await promiseAjax({
        url: './promise.php',
        type: 'get',
        data: 'id='+json1.code
    });
    var json2 = JSON.parse(data2);
    var data3 = await promiseAjax({
        url: './promise.php',
        type: 'get',
        data: 'id='+json2.code
    });
    var json3 = JSON.parse(data3);
    console.log(json3.address);
})();


</script>
</body>
</html>